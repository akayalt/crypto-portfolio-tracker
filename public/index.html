<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crypto Portfolio Tracker</title>
<style>
  body {
    background-color: #121212;
    color: #eee;
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  h1 {
    text-align: center;
    margin-bottom: 0.2em;
  }
  #summary {
    text-align: center;
    margin-bottom: 1em;
  }
  .usd-try-cell {
    background-color: #900;
    padding: 6px 12px;
    border-radius: 4px;
    display: inline-block;
    font-weight: bold;
  }
  #valueChartContainer {
    max-width: 900px;
    margin: 20px auto;
    background-color: #222;
    border: 1px solid #444;
    padding: 10px;
    border-radius: 6px;
    text-align: center;
  }
  #totalTryDisplay {
    font-size: 1.2em;
    margin: 10px 0;
    font-weight: bold;
  }
  canvas {
    display: block;
    margin: 0 auto;
  }
</style>
</head>
<body>

<h1>Crypto Portfolio Tracker</h1>

<div id="summary">
  <span class="usd-try-cell" id="usdTryRate">USD/TRY: --</span> |
  <span id="tryDelta"></span> |
  <span id="lastUpdated">Last Updated: --</span>
</div>

<div id="valueChartContainer">
  <div style="font-size: 1.2em; margin-bottom: 5px;">Total Portfolio Value (TRY)</div>
  <div id="totalTryDisplay">₺0.00</div>
  <canvas id="valueChart" width="900" height="400"></canvas>
</div>

<!-- The rest of your table, script, and logic remains unchanged -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let previousTotalTry = null;
let lastDelta = null;

const totalTryDisplay = document.getElementById("totalTryDisplay");
const tryDeltaEl = document.getElementById("tryDelta");
const lastUpdatedEl = document.getElementById("lastUpdated");
const usdTryEl = document.getElementById("usdTryRate");

// Chart setup
const chart = new Chart(document.getElementById("valueChart").getContext("2d"), {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Total Value (TRY)',
      data: [],
      borderColor: '#00ff00',
      backgroundColor: 'rgba(0,255,0,0.1)',
      tension: 0.1
    }]
  },
  options: {
    responsive: true,
    animation: false,
    plugins: {
      legend: { labels: { color: "#fff" } }
    },
    scales: {
      x: { ticks: { color: "#aaa" } },
      y: { ticks: { color: "#aaa" } }
    }
  }
});

async function loadHistoricalChartData() {
  try {
    const res = await fetch('/history');
    const history = await res.json();

    // Downsample: keep 1 out of every 10
    const downsampled = history.filter((_, index) => index % 10 === 0);

    downsampled.forEach(entry => {
      const label = new Date(entry.timestamp).toLocaleString(); // Full date + time
      chart.data.labels.push(label);
      chart.data.datasets[0].data.push(entry.total_try);
    });

    chart.update();
  } catch (err) {
    console.error("Failed to load chart data", err);
  }
}

async function fetchExchangeRate() {
  try {
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=usd&vs_currencies=try");
    const data = await res.json();
    const usdToTry = data.usd.try;
    usdTryEl.textContent = `USD/TRY: ₺${usdToTry.toFixed(2)}`;
    return usdToTry;
  } catch (e) {
    usdTryEl.textContent = `USD/TRY: Failed`;
    return 1;
  }
}

// Example of dynamic total TRY update logic (your existing price logic would be integrated here)
async function simulateTryUpdate() {
  const usdToTry = await fetchExchangeRate();
  const simulatedTotalTry = Math.random() * 100000; // Replace this with your live fetched value
  totalTryDisplay.textContent = `₺${simulatedTotalTry.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

  chart.data.labels.push(new Date().toLocaleString());
  chart.data.datasets[0].data.push(simulatedTotalTry);
  chart.update();

  lastUpdatedEl.textContent = `Last Updated: ${new Date().toLocaleTimeString()}`;
}

// Initialize
(async () => {
  await loadHistoricalChartData();
  await simulateTryUpdate();
  setInterval(simulateTryUpdate, 10000);
})();
</script>

</body>
</html>
